<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel Admin – Biblioteca</title>
<link rel="stylesheet" href="images/biblioteca.png">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#6200ee,#8e2de2); color:#fff; min-height:100vh; }
.sidebar { width:220px; height:100vh; background-color: rgba(0,0,0,0.4); float:left; padding-top:20px; box-shadow:2px 0 5px rgba(0,0,0,0.2); backdrop-filter:blur(5px); }
.dropdown-btn { background-color: transparent; color:white; padding:14px 20px; width:100%; border:none; text-align:left; cursor:pointer; font-size:16px; outline:none; transition:0.3s; }
.dropdown-btn:hover { background-color: rgba(255,255,255,0.1); }
.dropdown-container { display:none; background-color: rgba(0,0,0,0.3); padding-left:20px; }
.dropdown-container a { display:block; color:white; padding:10px 0; text-decoration:none; font-size:15px; transition:0.3s; }
.dropdown-container a:hover { background-color: rgba(255,255,255,0.1); }
.main-content { margin-left:220px; padding:30px; }
h1,h2{ color:#fff; margin-bottom:20px; }
input { width:200px; padding:8px; border-radius:4px; border:none; margin-bottom:6px; }
button{ padding:6px 12px; margin:2px; border:none; border-radius:4px; background:#03dac6; color:#333; cursor:pointer; transition:0.3s; }
button:hover{ background:#00bfa5; }
table{ width:100%; border-collapse: collapse; margin-top:10px; color:#fff; }
table th, table td{ padding:8px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.2); }
table th{ background-color: rgba(255,255,255,0.2); }
#registrar-container { display:flex; flex-direction:column; width:300px; }
#registrar-container input { margin-bottom:10px; width:100%; }
</style>
</head>
<body>

<div class="sidebar">
  <button class="dropdown-btn">Menu ⯆</button>
  <div class="dropdown-container">
    <a href="#" id="menu-registrar">Registrar Usuário</a>
    <a href="#" id="menu-importar-usuarios">importar Usuário</a>
    <a href="#" id="menu-usuarios">Usuários</a>
    <a href="#" id="menu-importar-livros">Importar Livros</a>
    <a href="#" id="menu-livros">Livros</a>
    <a href="#" id="menu-pedidos">Pedidos</a>
  </div>
</div>

<div class="main-content" id="main-content">
  <h1>Bem-vindo ao Painel Admin</h1>
  <p>Selecione uma opção do menu para gerenciar.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyAcEOwkyjBE7U6l6yPX7rpXhvmfjhpI7_4",
    authDomain: "jcd-biblioteca.firebaseapp.com",
    projectId: "jcd-biblioteca",
    storageBucket: "jcd-biblioteca.firebasestorage.app",
    messagingSenderId: "34676088650",
    appId: "1:34676088650:web:f8a76ebcd1e48e9440ebb3"
  };

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const mainContent = document.getElementById("main-content");

// Dropdown sidebar
document.querySelector('.dropdown-btn').addEventListener('click', () => {
  const container = document.querySelector('.dropdown-container');
  container.style.display = (container.style.display === 'block') ? 'none' : 'block';
});

document.getElementById("menu-importar-livros").addEventListener("click", () => {
  mainContent.innerHTML = `
    <h2>Importar Livros via CSV</h2>
    <p>O CSV deve conter as colunas: <strong>nome, autor, codigo</strong></p>
    <div id="import-container">
      <input type="file" id="csv-file" accept=".csv">
      <button id="import-btn">Importar</button>
      <div id="import-status" style="margin-top:15px;"></div>
    </div>
  `;

  // CSS customizado para a área de importação
  const style = document.createElement("style");
  style.innerHTML = `
    #import-container {
      display:flex; 
      flex-direction:column; 
      gap:10px; 
      max-width:400px;
      background: rgba(0,0,0,0.2);
      padding:20px;
      border-radius:10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #import-container input[type="file"] {
      padding:8px;
      border-radius:6px;
      border:none;
      cursor:pointer;
    }
    #import-container button {
      padding:10px;
      border:none;
      border-radius:6px;
      background:#03dac6;
      color:#000;
      font-weight:500;
      cursor:pointer;
      transition:0.3s;
    }
    #import-container button:hover {
      background:#00bfa5;
      color:#fff;
    }
    #import-status {
      font-size:14px;
      color:#fff;
      background: rgba(0,0,0,0.3);
      padding:10px;
      border-radius:6px;
      min-height:20px;
    }
  `;
  document.head.appendChild(style);

  const fileInput = document.getElementById("csv-file");
  const importBtn = document.getElementById("import-btn");
  const statusDiv = document.getElementById("import-status");

  importBtn.addEventListener("click", () => {
    const file = fileInput.files[0];
    if(!file) return alert("Selecione um arquivo CSV primeiro.");

    const reader = new FileReader();
    reader.onload = async (e) => {
      const text = e.target.result;
      const lines = text.split("\n").filter(l=>l.trim()!=="");
      if(lines.length < 2) return alert("CSV inválido!");

      const header = lines.shift().split(",").map(h=>h.trim().toLowerCase());
      if(!header.includes("nome") || !header.includes("autor") || !header.includes("codigo")){
        return alert("O CSV precisa ter as colunas: nome, autor, codigo");
      }

      let count = 0;
      for(const [index, line] of lines.entries()){
        const data = line.split(",").map(d=>d.trim());
        const livro = {};
        header.forEach((h,i)=> livro[h]=data[i]);
        livro.emprestado = false;
        try{
          await setDoc(doc(db,"books",crypto.randomUUID()), livro);
          count++;
          statusDiv.innerHTML = `Importando linha ${index + 1} de ${lines.length}...`;
        }catch(err){ console.error("Erro ao adicionar livro:",err);}
      }
      statusDiv.innerHTML = `Importação concluída! ${count} livros adicionados.`;
    };
    reader.readAsText(file);
  });
});

document.getElementById("menu-importar-usuarios").addEventListener("click", () => {
  mainContent.innerHTML = `
    <h2>Importar Usuários via CSV</h2>
    <p>O CSV deve conter a coluna: <strong>RA</strong></p>
    <div id="import-user-container">
      <input type="file" id="csv-user-file" accept=".csv">
      <button id="import-user-btn">Importar</button>
      <div id="import-user-status" style="margin-top:15px;"></div>
    </div>
  `;

  // CSS customizado
  const style = document.createElement("style");
  style.innerHTML = `
    #import-user-container {
      display:flex; 
      flex-direction:column; 
      gap:10px; 
      max-width:400px;
      background: rgba(0,0,0,0.2);
      padding:20px;
      border-radius:10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #import-user-container input[type="file"] {
      padding:8px;
      border-radius:6px;
      border:none;
      cursor:pointer;
    }
    #import-user-container button {
      padding:10px;
      border:none;
      border-radius:6px;
      background:#03dac6;
      color:#000;
      font-weight:500;
      cursor:pointer;
      transition:0.3s;
    }
    #import-user-container button:hover {
      background:#00bfa5;
      color:#fff;
    }
    #import-user-status {
      font-size:14px;
      color:#fff;
      background: rgba(0,0,0,0.3);
      padding:10px;
      border-radius:6px;
      min-height:20px;
    }
  `;
  document.head.appendChild(style);

  const fileInput = document.getElementById("csv-user-file");
  const importBtn = document.getElementById("import-user-btn");
  const statusDiv = document.getElementById("import-user-status");

  importBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if(!file) return alert("Selecione um arquivo CSV primeiro.");

    const reader = new FileReader();
    reader.onload = async (e) => {
      const text = e.target.result;
      const lines = text.split("\n").filter(l=>l.trim()!=="");
      if(lines.length < 2) return alert("CSV inválido!");

      const header = lines.shift().split(",").map(h=>h.trim().toLowerCase());
      if(!header.includes("ra")) return alert("O CSV precisa ter a coluna RA");

      let count = 0;
      const defaultPassword = "12345678#Jcd";

      for(const [index, line] of lines.entries()){
        const data = line.split(",").map(d=>d.trim());
        const raRaw = data[header.indexOf("ra")];
        if(!raRaw) continue;

        // Garante 4 zeros no início e sp no final
        let ra = raRaw.replace(/^0+/, ""); // remove zeros iniciais
        ra = ra.padStart(ra.length + 4, "0"); // adiciona 4 zeros
        if(!ra.toLowerCase().endsWith("sp")) ra += "sp";

        const email = ra + "@al.educacao.sp.gov.br";

        try {
          // Verifica se email já existe
          const usersSnap = await getDocs(collection(db, "users"));
          const exists = usersSnap.docs.some(u => u.data().email === email);
          if(exists){
            statusDiv.innerHTML = `Linha ${index + 1}: Usuário ${email} já existe. Pulando...`;
            continue;
          }

          // Cria usuário no Firebase Auth
          const cred = await createUserWithEmailAndPassword(auth, email, defaultPassword);

          // Adiciona usuário no Firestore
          await setDoc(doc(db, "users", cred.user.uid), {
            username: "", // você pode colocar o nome depois
            ra: raRaw,
            email,
            role: "user",
            uidLivro: ""
          });

          count++;
          statusDiv.innerHTML = `Importando linha ${index + 1} de ${lines.length}...`;
        } catch (err) {
          console.error(`Erro na linha ${index + 1}:`, err);
        }
      }

      statusDiv.innerHTML = `Importação concluída! ${count} usuários adicionados.`;
    };

    reader.readAsText(file);
  });
});
// ====== Registrar Usuário ======
document.getElementById("menu-registrar").addEventListener("click", () => {
  mainContent.innerHTML = `
    <h2>Registrar Usuário</h2>
    <div id="registrar-container">
      <input id="r-user" placeholder="Nome de usuário">
      <input id="r-ra" placeholder="RA">
      <input id="r-password" type="password" placeholder="Senha">
      <button id="btn-registrar">Registrar</button>
    </div>
  `;

  document.getElementById("btn-registrar").addEventListener("click", async () => {
    const username = document.getElementById("r-user").value.trim();
    let ra = document.getElementById("r-ra").value.trim();
    const password = document.getElementById("r-password").value.trim();

    if (!username || !ra || !password) return alert("Preencha todos os campos");

    // Garante que o RA tenha 4 zeros no início
    ra = ra.replace(/^0+/, "");           // Remove zeros existentes
    ra = ra.padStart(ra.length + 4, "0"); // Adiciona exatamente 4 zeros no início

    // Criar email automático sempre com @al.educacao.sp.gov.br
    const email = ra + "sp@al.educacao.sp.gov.br";

    try {
      // Verificar se o email já existe
      const usersSnap = await getDocs(collection(db, "users"));
      const emailExists = usersSnap.docs.some(doc => doc.data().email === email);
      if (emailExists) {
        return alert(`Usuário com o email ${email} já existe!`);
      }

      // Criar usuário no Firebase Auth
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", cred.user.uid), { username, ra, email, role: "user", uidLivro: "" });
      alert(`Usuário registrado com sucesso! Email: ${email}`);
      document.getElementById("r-user").value = "";
      document.getElementById("r-ra").value = "";
      document.getElementById("r-password").value = "";
    } catch (e) {
      console.error(e);
      alert("Erro ao registrar usuário");
    }
  });
});


// ====== Registrar Usuário ======
// ====== Usuários ======
document.getElementById("menu-usuarios").addEventListener("click", async () => {
  mainContent.innerHTML = "<h2>Usuários</h2>";

  // Buscar usuários e livros
  const usersSnap = await getDocs(collection(db, "users"));
  const users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

  const booksSnap = await getDocs(collection(db, "books"));
  const booksMap = {};
  booksSnap.forEach(b => booksMap[b.id] = b.data().nome);

  // Criar tabela
  const table = document.createElement("table");
  table.innerHTML = `<thead>
    <tr>
      <th>Username</th>
      <th>RA</th>
      <th>Email</th>
      <th>Role</th>
      <th>Livro</th>
      <th>Ações</th>
    </tr>
  </thead><tbody></tbody>`;
  mainContent.appendChild(table);
  const tbody = table.querySelector("tbody");

  // Criar input de filtro
  const filterInput = document.createElement("input");
  filterInput.placeholder = "Filtrar por nome, RA, email ou role...";
  filterInput.style.marginBottom = "10px";
  filterInput.style.padding = "6px";
  filterInput.style.borderRadius = "6px";
  filterInput.style.border = "1px solid #ccc";
  filterInput.style.width = "300px";
  mainContent.insertBefore(filterInput, table);

  function renderUsers(filterText = "") {
    tbody.innerHTML = "";
    const lowerFilter = filterText.toLowerCase();

    users.filter(u => {
      const username = (u.username || "").toLowerCase();
      const ra = (u.ra || "").toLowerCase();
      const email = (u.email || "").toLowerCase();
      const role = (u.role || "").toLowerCase();
      return username.includes(lowerFilter) ||
             ra.includes(lowerFilter) ||
             email.includes(lowerFilter) ||
             role.includes(lowerFilter);
    }).forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" value="${u.username}" readonly></td>
        <td><input type="text" value="${u.ra}" readonly></td>
        <td><input type="email" value="${u.email}" readonly></td>
        <td><input type="text" value="${u.role}" readonly></td>
        <td>${u.uidLivro ? booksMap[u.uidLivro] || "Livro não encontrado" : ""}</td>
        <td>
          <button class="edit-btn">Editar</button>
          <button class="save-btn" style="display:none;">Salvar</button>
          <button class="delete-btn">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);

      const editBtn = tr.querySelector(".edit-btn");
      const saveBtn = tr.querySelector(".save-btn");

      // Editar usuário
      editBtn.addEventListener("click", () => {
        tr.querySelectorAll("input").forEach(i => i.removeAttribute("readonly"));
        editBtn.style.display = "none";
        saveBtn.style.display = "inline-block";
      });

      // Salvar alterações
      saveBtn.addEventListener("click", async () => {
        const updated = {
          username: tr.children[0].children[0].value,
          ra: tr.children[1].children[0].value,
          email: tr.children[2].children[0].value,
          role: tr.children[3].children[0].value
        };
        try {
          await setDoc(doc(db, "users", u.id), { ...u, ...updated });
          alert("Usuário atualizado!");
          tr.querySelectorAll("input").forEach(i => i.setAttribute("readonly", true));
          saveBtn.style.display = "none";
          editBtn.style.display = "inline-block";
        } catch (e) {
          console.error(e);
          alert("Erro ao atualizar usuário");
        }
      });

      // Excluir usuário
      tr.querySelector(".delete-btn").addEventListener("click", async () => {
        if (confirm(`Deseja excluir ${u.username}?`)) {
          await deleteDoc(doc(db, "users", u.id));
          tr.remove();
        }
      });
    });
  }

  // Renderizar inicialmente
  renderUsers();

  // Atualizar tabela ao digitar no filtro
  filterInput.addEventListener("input", e => renderUsers(e.target.value));
});



// ====== Usuários ======

// ====== Livros ======
document.getElementById("menu-livros").addEventListener("click", async () => {
  mainContent.innerHTML = "<h2>Livros</h2>";

  // Botão para adicionar livro
  const addBtn = document.createElement("button");
  addBtn.textContent = "Adicionar Livro";
  addBtn.style.marginBottom = "15px";
  mainContent.appendChild(addBtn);

  // Filtro de livros
  const filterInput = document.createElement("input");
  filterInput.placeholder = "Filtrar livros por nome...";
  filterInput.style.marginBottom = "15px";
  filterInput.style.padding = "8px";
  filterInput.style.borderRadius = "6px";
  filterInput.style.border = "1px solid #ccc";
  filterInput.style.width = "300px";
  mainContent.appendChild(filterInput);

  // Tabela de livros
  const table = document.createElement("table");
  table.innerHTML = `<thead><tr><th>Nome</th><th>Código</th><th>Autor</th><th>Emprestado</th><th>Ações</th></tr></thead><tbody></tbody>`;
  mainContent.appendChild(table);
  const tbody = table.querySelector("tbody");

  async function renderBooks(filterText = "") {
  tbody.innerHTML = "";

  const booksSnap = await getDocs(collection(db, "books"));
  const usersSnap = await getDocs(collection(db, "users"));
  const books = booksSnap.docs.map(d => ({ id: d.id, ...d.data() }));
  const users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

  // Filtrar livros pelo nome, garantindo que b.nome exista
  const filteredBooks = books.filter(b => ((b.nome || "").toLowerCase()).includes(filterText.toLowerCase()));

  filteredBooks.forEach(b => {
    let emprestadoNome = "Não";
    let btnDev = "";
    if (b.emprestado) {
      const u = users.find(x => x.uidLivro === b.id);
      emprestadoNome = u ? u.username : "Desconhecido";
      btnDev = `<button class="devolver-btn">Devolver</button>`;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${b.nome || ""}</td>
                    <td>${b.codigo || ""}</td>
                    <td>${b.autor || ""}</td>
                    <td>${emprestadoNome}</td>
                    <td>
                      <button class="edit-btn">Editar</button>
                      ${btnDev}
                      <button class="delete-btn">Excluir</button>
                    </td>`;
    tbody.appendChild(tr);

    // Editar livro
    tr.querySelector(".edit-btn").addEventListener("click", async () => {
      const nome = prompt("Nome:", b.nome || "");
      const codigo = prompt("Código:", b.codigo || "");
      const autor = prompt("Autor:", b.autor || "");
      if (nome && codigo && autor) {
        await setDoc(doc(db, "books", b.id), { ...b, nome, codigo, autor });
        renderBooks(filterText);
      }
    });

    // Devolver livro
    const devolverBtn = tr.querySelector(".devolver-btn");
    if (devolverBtn) {
      devolverBtn.addEventListener("click", async () => {
        const uDoc = users.find(x => x.uidLivro === b.id);
        if (uDoc) await setDoc(doc(db, "users", uDoc.id), { ...uDoc, uidLivro: "" });
        await setDoc(doc(db, "books", b.id), { ...b, emprestado: false });
        renderBooks(filterText);
      });
    }

    // Excluir livro
    tr.querySelector(".delete-btn").addEventListener("click", async () => {
      if (confirm(`Deseja excluir o livro "${b.nome || "Desconhecido"}"?`)) {
        await deleteDoc(doc(db, "books", b.id));
        renderBooks(filterText);
      }
    });
  });
}


  // Listener do filtro
  filterInput.addEventListener("input", e => renderBooks(e.target.value));

  // Listener do botão adicionar
  addBtn.addEventListener("click", async () => {
    const nome = prompt("Nome do livro:");
    if (!nome) return;
    const codigo = prompt("Código:");
    if (!codigo) return;
    const autor = prompt("Autor:");
    if (!autor) return;
    await setDoc(doc(db, "books", crypto.randomUUID()), { nome, codigo, autor, emprestado: false });
    renderBooks(filterInput.value);
  });

  // Renderizar livros inicialmente
  renderBooks();
});

// ====== Manual ======
const manualMenu = document.createElement("a");
manualMenu.href = "#";
manualMenu.id = "menu-manual";
manualMenu.textContent = "Manual";
document.querySelector(".dropdown-container").appendChild(manualMenu);

document.getElementById("menu-manual").addEventListener("click", async () => {
  mainContent.innerHTML = "<h2>Empréstimo Manual</h2>";

  const usersSnap = await getDocs(collection(db,"users"));
  const booksSnap = await getDocs(collection(db,"books"));

  const users = usersSnap.docs.map(d=>({ id:d.id, ...d.data() }));
  const books = booksSnap.docs.map(d=>({ id:d.id, ...d.data() }));

  // Filtro
  const filterInput = document.createElement("input");
  filterInput.placeholder = "Filtrar usuários por nome...";
  filterInput.style.marginBottom = "15px";
  filterInput.style.padding = "10px";
  filterInput.style.borderRadius = "8px";
  filterInput.style.border = "1px solid #ccc";
  filterInput.style.width = "300px";
  mainContent.appendChild(filterInput);

  const userContainer = document.createElement("div");
  userContainer.style.display = "flex";
  userContainer.style.flexWrap = "wrap";
  userContainer.style.gap = "15px";
  mainContent.appendChild(userContainer);

  function renderUsers(filterText=""){
    userContainer.innerHTML = "";
    users.filter(u=>u.username.toLowerCase().includes(filterText.toLowerCase()))
         .forEach(u=>{
      const div = document.createElement("div");
      div.style.background="rgba(255,255,255,0.05)";
      div.style.padding="15px";
      div.style.borderRadius="10px";
      div.style.display="flex";
      div.style.alignItems="center";
      div.style.justifyContent="space-between";
      div.style.minWidth = "220px";
      div.style.boxShadow = "0 4px 6px rgba(0,0,0,0.2)";
      div.style.transition = "transform 0.2s, background 0.2s";
      div.addEventListener("mouseenter", ()=>div.style.transform="translateY(-3px)");
      div.addEventListener("mouseleave", ()=>div.style.transform="translateY(0)");
      
      div.innerHTML = `<span style="font-weight:500;">${u.username}</span>`;
      userContainer.appendChild(div);

      if(!u.uidLivro){
        const btn = document.createElement("button");
        btn.textContent = "Emprestar";
        btn.style.background="#03dac6";
        btn.style.border="none";
        btn.style.borderRadius="5px";
        btn.style.padding="6px 12px";
        btn.style.cursor="pointer";
        btn.style.transition="0.3s";
        btn.addEventListener("mouseenter", ()=>btn.style.background="#00bfa5");
        btn.addEventListener("mouseleave", ()=>btn.style.background="#03dac6");
        div.appendChild(btn);

        btn.addEventListener("click", () => {
          // Modal
          const modal = document.createElement("div");
          modal.style.position="fixed";
          modal.style.top="0";
          modal.style.left="0";
          modal.style.width="100%";
          modal.style.height="100%";
          modal.style.background="rgba(0,0,0,0.7)";
          modal.style.display="flex";
          modal.style.alignItems="center";
          modal.style.justifyContent="center";
          modal.style.zIndex="9999";

          modal.innerHTML = `
            <div style="
              background:#fff; 
              color:#000; 
              padding:25px; 
              border-radius:12px; 
              width:90%; 
              max-width:700px; 
              max-height:80%; 
              display:flex; 
              flex-direction:column;
              box-shadow:0 8px 16px rgba(0,0,0,0.3);">
              <h3 style="margin-bottom:15px;">Escolha um livro para ${u.username}</h3>
              <input type="text" id="book-filter" placeholder="Filtrar livros..." style="
                padding:10px; 
                border-radius:6px; 
                border:1px solid #ccc; 
                margin-bottom:15px;">
              <div id="book-list" style="
                display:grid; 
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
                gap:10px; 
                overflow-y:auto; 
                flex-grow:1;">
              </div>
              <button id="close-modal" style="
                margin-top:15px; 
                padding:8px 15px; 
                border:none; 
                border-radius:6px; 
                background:#6200ee; 
                color:#fff; 
                cursor:pointer;
                align-self:flex-end;">Fechar</button>
            </div>
          `;
          document.body.appendChild(modal);

          const bookList = modal.querySelector("#book-list");
          const bookFilter = modal.querySelector("#book-filter");
          const closeModal = modal.querySelector("#close-modal");

          function renderBooks(filterText=""){
            bookList.innerHTML = "";
            books.filter(b=>!b.emprestado && b.nome.toLowerCase().includes(filterText.toLowerCase()))
                 .forEach(b=>{
              const card = document.createElement("div");
              card.style.background="rgba(3,218,198,0.1)";
              card.style.padding="10px";
              card.style.borderRadius="8px";
              card.style.cursor="pointer";
              card.style.transition="transform 0.2s, background 0.2s";
              card.innerHTML = `<strong>${b.nome}</strong><br><span style="font-size:12px;">${b.autor}</span>`;
              card.addEventListener("mouseenter", ()=>card.style.transform="translateY(-2px)");
              card.addEventListener("mouseleave", ()=>card.style.transform="translateY(0)");
              card.addEventListener("dblclick", async ()=>{
                await setDoc(doc(db,"users",u.id), {...u, uidLivro: b.id});
                await setDoc(doc(db,"books",b.id), {...b, emprestado:true});
                alert(`Livro "${b.nome}" emprestado para ${u.username}`);
                document.body.removeChild(modal);
              });
              bookList.appendChild(card);
            });
          }

          renderBooks();

          bookFilter.addEventListener("input", e=>renderBooks(e.target.value));
          closeModal.addEventListener("click", ()=>document.body.removeChild(modal));
        });
      }
    });
  }

  renderUsers();
  filterInput.addEventListener("input", e=>renderUsers(e.target.value));
});


// ====== Pedidos ======
document.getElementById("menu-pedidos").addEventListener("click", async ()=>{
  mainContent.innerHTML="<h2>Pedidos</h2>";
  const pedSnap = await getDocs(collection(db,"notifications"));
  const pedidos = pedSnap.docs.map(d=>({ id:d.id, ...d.data() })).filter(p=>p.tipo==="pedido" && p.status==="pendente");

  const usersSnap = await getDocs(collection(db,"users"));
  const booksSnap = await getDocs(collection(db,"books"));
  const users = usersSnap.docs.map(d=>({ id:d.id, ...d.data() }));
  const books = booksSnap.docs.map(d=>({ id:d.id, ...d.data() }));

  const table = document.createElement("table");
  table.innerHTML=`<thead><tr><th>Usuário</th><th>Livro</th><th>Ações</th></tr></thead><tbody></tbody>`;
  mainContent.appendChild(table);
  const tbody = table.querySelector("tbody");

  pedidos.forEach(p=>{
    const u = users.find(x=>x.id===p.uidUsuario);
    const b = books.find(x=>x.id===p.uidLivro);
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${u.username}</td><td>${b.nome}</td>
                  <td>
                    <button class="aceitar-btn">Aceitar</button>
                    <button class="rejeitar-btn">Rejeitar</button>
                  </td>`;
    tbody.appendChild(tr);

    tr.querySelector(".aceitar-btn").addEventListener("click", async ()=>{
      if(u.uidLivro){
        alert("Usuário já possui um livro!");
        return;
      }
      await setDoc(doc(db,"users",u.id),{...u,uidLivro:b.id});
      await setDoc(doc(db,"books",b.id),{...b,emprestado:true});
      await setDoc(doc(db,"notifications",p.id),{...p,status:"aceito"});
      tr.remove();
    });

    tr.querySelector(".rejeitar-btn").addEventListener("click", async ()=>{
      await setDoc(doc(db,"notifications",p.id),{...p,status:"rejeitado"});
      tr.remove();
    });
  });
});
</script>
</body>
</html>
